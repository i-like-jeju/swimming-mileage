<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì´ë ¥ ì¡°íšŒ</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #f5f6f8;
}
h1 {
  text-align: center;
  padding: 16px;
}
.container {
  max-width: 480px;
  margin: auto;
  padding: 12px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
.record-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid #eee;
}
.record-item:last-child {
  border-bottom: none;
}
.record-info {
  flex: 1;
}
.record-date {
  font-size: 14px;
  color: #666;
  margin-bottom: 4px;
}
.record-distance {
  font-size: 16px;
  font-weight: 600;
}
.delete-btn {
  background: none;
  border: none;
  color: #ff4444;
  font-size: 20px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
}
.delete-btn:hover {
  background: #ffe0e0;
}
.back-btn {
  display: inline-block;
  margin: 16px;
  padding: 10px 20px;
  background: #0066ff;
  color: #fff;
  text-decoration: none;
  border-radius: 8px;
  font-weight: bold;
}
</style>
</head>

<body>
<h1>ğŸ“‹ ì´ë ¥ ì¡°íšŒ</h1>

<div class="container">
  <a href="index.html" class="back-btn">â† ëŒì•„ê°€ê¸°</a>
  <div class="card">
    <div id="memberName"></div>
    <div id="recordsList"></div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://tsropshzbqrfladkgwsr.supabase.co",
  "sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm"
);

// URL íŒŒë¼ë¯¸í„°ì—ì„œ member_id ê°€ì ¸ì˜¤ê¸°
const urlParams = new URLSearchParams(window.location.search);
const memberId = parseInt(urlParams.get('member_id'));

if (!memberId) {
  alert('ë©¤ë²„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
  window.location.href = 'index.html';
}

async function loadHistory() {
  // ë©¤ë²„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const { data: member } = await sb
    .from("members")
    .select("*")
    .eq("id", memberId)
    .single();

  if (!member) {
    alert('ë©¤ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    window.location.href = 'index.html';
    return;
  }

  document.getElementById("memberName").innerHTML = `<h2>${member.name}ì˜ ê¸°ë¡</h2>`;

  // ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (deleted = falseì¸ ê²ƒë§Œ, id ì˜¤ë¦„ì°¨ìˆœ)
  const { data: records } = await sb
    .from("records")
    .select("*")
    .eq("member_id", memberId)
    .eq("deleted", false)
    .order("id", { ascending: true });

  // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (deleteRecord í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
  window.currentRecords = records || [];

  const recordsList = document.getElementById("recordsList");
  recordsList.innerHTML = "";

  if (!records || records.length === 0) {
    recordsList.innerHTML = "<div style='text-align: center; padding: 20px; color: #999;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }

  records.forEach(record => {
    const date = new Date(record.created_at);
    const dateString = date.toLocaleString('ko-KR', {
      year: '2-digit',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    }).replace(/\. /g, '.').replace(/\.$/, '').replace(/\.(?=[^.]*$)/, ' ');

    const recordItem = document.createElement("div");
    recordItem.className = "record-item";
    recordItem.innerHTML = `
      <div class="record-info">
        <div class="record-date">${dateString}</div>
        <div class="record-distance">${record.base_distance}km (${record.weighted_mileage}km)</div>
      </div>
      <button class="delete-btn" onclick="deleteRecord(${record.id})" title="ì‚­ì œ">âœ•</button>
    `;
    recordsList.appendChild(recordItem);
  });
}

async function deleteRecord(recordId) {
  // ì‚­ì œí•˜ë ¤ëŠ” ê¸°ë¡ ì •ë³´ ì°¾ê¸°
  const record = window.currentRecords.find(r => r.id === recordId);
  
  if (!record) {
    alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ë‚ ì§œì‹œê°„ í¬ë§·íŒ…
  const date = new Date(record.created_at);
  const dateString = date.toLocaleString('ko-KR', {
    year: '2-digit',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).replace(/\. /g, '.').replace(/\.$/, '').replace(/\.(?=[^.]*$)/, ' ');

  // í™•ì¸ ë©”ì‹œì§€ì— ê¸°ë¡ ì •ë³´ í¬í•¨
  const confirmMessage = `ì •ë§ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‚ ì§œì‹œê°„: ${dateString}\në§ˆì¼ë¦¬ì§€: ${record.base_distance}km (${record.weighted_mileage}km)`;
  
  if (!confirm(confirmMessage)) {
    // ì·¨ì†Œ ì‹œ ì´ë ¥ ëª©ë¡ ìœ ì§€ (ì•„ë¬´ ì‘ì—… ì—†ìŒ)
    return;
  }

  // í™•ì¸ ì‹œ ì‚­ì œ ì²˜ë¦¬
  const { error } = await sb
    .from("records")
    .update({ deleted: true })
    .eq("id", recordId);

  if (error) {
    alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
    return;
  }

  alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  loadHistory(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
}

loadHistory();
</script>
</body>
</html>

