<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ í˜„í™©</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
*, *::before, *::after { box-sizing: border-box; }
html, body {
  margin:0; padding:0; width:100%;
  overflow-x:hidden; font-family:system-ui;
  background:#f5f6f8;
}
h1 { text-align:center; padding:16px 8px; margin:0; }
.container { max-width:480px; margin:auto; padding:12px; }
.card {
  background:#fff; border-radius:12px;
  padding:16px; margin-bottom:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}
select,input,button {
  width:100%; padding:10px; margin-top:6px;
  border-radius:8px; border:1px solid #ccc;
  font-size:16px;
}
button { background:#0066ff; color:#fff; font-weight:bold; border:none; }
.check {
  display:grid; grid-template-columns:20px 1fr;
  gap:8px; font-size:14px; margin-top:8px;
}
.check span { word-break:break-word; }
.preview {
  background:#eef3ff; padding:8px;
  border-radius:6px; margin-top:10px;
  font-size:14px;
}
.progress {
  width:100%; height:10px; background:#ddd;
  border-radius:6px; overflow:hidden;
  margin:6px 0 10px;
}
.progress div { height:100%; background:#4caf50; }
.team { margin-top:14px; font-weight:bold; }
.member { font-size:14px; margin-left:10px; }
.rank { font-size:14px; margin-left:10px; }
a { color:#0066ff; text-decoration:none; }
</style>
</head>

<body>
<h1>ğŸŠ ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ í˜„í™©</h1>

<div class="container">

<div class="card">
<h2>ê¸°ë¡ ì¶”ê°€</h2>
<select id="teamSelect"></select>
<select id="memberSelect" disabled></select>
<input type="number" id="distance" step="0.001" placeholder="ì˜ˆ: 3.125">

<div class="check"><input type="checkbox" id="w3"><span>3ì¸ ìˆ˜ì˜ (x1.1)</span></div>
<div class="check"><input type="checkbox" id="wSea"><span>ë°”ë‹¤ ìˆ˜ì˜ (x2)</span></div>

<div class="preview">
ê°€ì¤‘ì¹˜: <b id="wText">x1</b><br>
ë°˜ì˜ ë§ˆì¼ë¦¬ì§€: <b id="mText">0.0</b>
</div>

<input type="file" id="proof">
<button onclick="saveRecord()">ì €ì¥</button>
</div>

<div class="card">
<h2>ğŸ† ë©¤ë²„ ë­í‚¹</h2>
<div id="ranking"></div>
</div>

<div class="card">
<h2>íŒ€ í˜„í™©</h2>
<div id="board"></div>
</div>

</div>

<script>
const sb = supabase.createClient(
  "https://tsropshzbqrfladkgwsr.supabase.co",
  "sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm"
);

const teamSel = document.getElementById("teamSelect");
const memberSel = document.getElementById("memberSelect");
const dist = document.getElementById("distance");
const w3 = document.getElementById("w3");
const wSea = document.getElementById("wSea");

function floor1(n){ return Math.floor(n*10)/10; }

function calc(){
  let w=1;
  if(w3.checked)w*=1.1;
  if(wSea.checked)w*=2;
  wText.innerText="x"+w.toFixed(1);
  mText.innerText=floor1((dist.value||0)*w).toFixed(1);
}
dist.oninput=w3.onchange=wSea.onchange=calc;

function renderProofLinks(memberId, records){
  const proofs = records.filter(r=>r.member_id===memberId && r.proof_url);
  if(proofs.length===0) return "";
  return `
    <div style="margin-left:18px;font-size:13px;">
      ${proofs.map((p,i)=>
        `<a href="${p.proof_url}" target="_blank">ğŸ“ ì¦ë¹™${i+1}</a>`
      ).join(" Â· ")}
    </div>
  `;
}

async function init(){
  const {data:teams}=await sb.from("teams").select("*").order("id");
  teamSel.innerHTML=`<option value="">íŒ€ ì„ íƒ</option>`;
  teams.forEach(t=>teamSel.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
}
teamSel.onchange=async()=>{
  const {data}=await sb.from("members").select("*").eq("team_id",teamSel.value);
  memberSel.innerHTML=`<option value="">ë©¤ë²„ ì„ íƒ</option>`;
  data.forEach(m=>memberSel.innerHTML+=`<option value="${m.id}">${m.name}</option>`);
  memberSel.disabled=false;
};

async function saveRecord(){
  let w=1;
  if(w3.checked)w*=1.1;
  if(wSea.checked)w*=2;

  let proof=null;
  const f=proofInput.files[0];
  if(f){
    const p=`proofs/${Date.now()}_${f.name}`;
    await sb.storage.from("proofs").upload(p,f);
    proof=sb.storage.from("proofs").getPublicUrl(p).data.publicUrl;
  }

  await sb.from("records").insert({
    member_id:memberSel.value,
    base_distance:Number(dist.value).toFixed(3),
    weighted_mileage:(dist.value*w).toFixed(3),
    weight_3person:w3.checked,
    weight_sea:wSea.checked,
    proof_url:proof
  });

  dist.value=""; w3.checked=wSea.checked=false; calc();
  load();
}

async function load(){
  const {data:teams}=await sb.from("teams").select("*");
  const {data:members}=await sb.from("members").select("*");
  const {data:records}=await sb.from("records").select("*");

  ranking.innerHTML="";
  const sum={};
  records.forEach(r=>sum[r.member_id]=(sum[r.member_id]||0)+Number(r.weighted_mileage));
  Object.entries(sum).sort((a,b)=>b[1]-a[1]).forEach(([id,v],i)=>{
    const name=members.find(m=>m.id==id).name;
    ranking.innerHTML+=`<div class="rank">${i+1}. ${name} ${floor1(v).toFixed(1)}km</div>`;
  });

  board.innerHTML="";
  teams.forEach(t=>{
    const tm=members.filter(m=>m.team_id===t.id);
    const tr=records.filter(r=>tm.some(m=>m.id===r.member_id));
    const total=tr.reduce((s,r)=>s+Number(r.weighted_mileage),0);

    board.innerHTML+=`
      <div class="team">â— ${t.name} (${floor1(total).toFixed(1)} / ${t.target_mileage})</div>
      <div class="progress"><div style="width:${Math.min(100,total/t.target_mileage*100)}%"></div></div>
    `;

    tm.map(m=>{
      const s=tr.filter(r=>r.member_id===m.id).reduce((a,b)=>a+Number(b.weighted_mileage),0);
      return {id:m.id,name:m.name,sum:s};
    }).sort((a,b)=>b.sum-a.sum).forEach((m,i)=>{
      const medal=i==0?"ğŸ¥‡":i==1?"ğŸ¥ˆ":i==2?"ğŸ¥‰":"";
      board.innerHTML+=`
        <div class="member">
          ${m.name} ${floor1(m.sum).toFixed(1)}km ${medal}
          ${renderProofLinks(m.id, records)}
        </div>
      `;
    });
  });
}

init(); load();
</script>
</body>
</html>
