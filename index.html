<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§ˆì¼ë¦¬ì§€ í˜„í™©</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body { margin:0; font-family:system-ui; background:#f5f6f8; }
h1 { text-align:center; padding:16px; }
.container { max-width:480px; margin:auto; padding:12px; }
.card { background:#fff; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
select,input,button { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; }
button { background:#0066ff; color:#fff; font-weight:bold; border:none; }
.check { display:grid; grid-template-columns:20px 1fr; gap:8px; font-size:14px; margin-top:6px; }
.preview { background:#eef3ff; padding:8px; border-radius:6px; margin-top:10px; font-size:14px; }
.progress { height:10px; background:#ddd; border-radius:6px; overflow:hidden; }
.progress div { height:100%; background:#4caf50; }
.team { margin-top:14px; font-weight:bold; }
.member { font-size:14px; margin-left:10px; }
.rank { font-size:14px; }
</style>
</head>

<body>
<h1>ğŸŠ ë§ˆì¼ë¦¬ì§€ í˜„í™©</h1>

<div class="container">

<div class="card">
<h2>ê¸°ë¡ ì¶”ê°€ / ìˆ˜ì •</h2>

<select id="teamSelect"></select>
<select id="memberSelect" disabled></select>

<input type="number" id="distance" step="0.001" placeholder="ê±°ë¦¬ km">

<div class="check"><input type="checkbox" id="w3"><span>3ì¸ ìˆ˜ì˜ (x1.1)</span></div>
<div class="check"><input type="checkbox" id="wSea"><span>ë°”ë‹¤ ìˆ˜ì˜ (x2)</span></div>

<div class="preview">
ê°€ì¤‘ì¹˜: <b id="wText">x1</b><br>
ë°˜ì˜ ë§ˆì¼ë¦¬ì§€: <b id="mText">0.000</b>
</div>

<input type="file" id="proof">
<button onclick="save()">ì €ì¥</button>
</div>

<div class="card">
<h2>ğŸ† ë©¤ë²„ ë­í‚¹</h2>
<div id="ranking"></div>
</div>

<div class="card">
<h2>íŒ€ í˜„í™©</h2>
<div id="board"></div>
</div>

</div>

<script>
const sb = supabase.createClient(
  "https://tsropshzbqrfladkgwsr.supabase.co",
  "sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm"
);

const teamSel = document.getElementById("teamSelect");
const memberSel = document.getElementById("memberSelect");
const dist = document.getElementById("distance");
const w3 = document.getElementById("w3");
const wSea = document.getElementById("wSea");

function calc(){
  let w=1;
  if(w3.checked)w*=1.1;
  if(wSea.checked)w*=2;
  document.getElementById("wText").innerText="x"+w.toFixed(1);
  document.getElementById("mText").innerText=((dist.value||0)*w).toFixed(3);
}
dist.oninput=w3.onchange=wSea.onchange=calc;

async function init(){
  const {data:teams}=await sb.from("teams").select("*").order("id");
  teamSel.innerHTML=`<option value="">íŒ€ ì„ íƒ</option>`;
  teams.forEach(t=>teamSel.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
}
teamSel.onchange=async()=>{
  const {data}=await sb.from("members").select("*").eq("team_id",teamSel.value);
  memberSel.innerHTML=`<option value="">ë©¤ë²„ ì„ íƒ</option>`;
  data.forEach(m=>memberSel.innerHTML+=`<option value="${m.id}">${m.name}</option>`);
  memberSel.disabled=false;
};

async function save(){
  let w=1;
  if(w3.checked)w*=1.1;
  if(wSea.checked)w*=2;

  let proof=null;
  const f=document.getElementById("proof").files[0];
  if(f){
    const p=`proofs/${Date.now()}_${f.name}`;
    await sb.storage.from("proofs").upload(p,f);
    proof=sb.storage.from("proofs").getPublicUrl(p).data.publicUrl;
  }

  await sb.from("records").insert({
    member_id:memberSel.value,
    base_distance:dist.value,
    weighted_mileage:(dist.value*w).toFixed(3),
    weight_3person:w3.checked,
    weight_sea:wSea.checked,
    proof_url:proof
  });

  dist.value=""; w3.checked=wSea.checked=false; calc();
  load();
}

async function load(){
  const {data:teams}=await sb.from("teams").select("*");
  const {data:members}=await sb.from("members").select("*");
  const {data:records}=await sb.from("records").select("*");

  /* ë­í‚¹ */
  const sums={};
  records.forEach(r=>{
    sums[r.member_id]=(sums[r.member_id]||0)+Number(r.weighted_mileage);
  });
  const rankDiv=document.getElementById("ranking");
  rankDiv.innerHTML="";
  Object.entries(sums)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([id,val],i)=>{
      const name=members.find(m=>m.id==id).name;
      rankDiv.innerHTML+=`<div class="rank">${i+1}. ${name} ${val.toFixed(3)}km</div>`;
    });

  /* íŒ€ */
  const board=document.getElementById("board");
  board.innerHTML="";
  teams.forEach(t=>{
    const tm=members.filter(m=>m.team_id===t.id);
    const tr=records.filter(r=>tm.some(m=>m.id===r.member_id));
    const total=tr.reduce((s,r)=>s+Number(r.weighted_mileage),0);

    board.innerHTML+=`<div class="team">â— ${t.name} (${total.toFixed(3)}/${t.target_mileage})</div>
    <div class="progress"><div style="width:${Math.min(100,total/t.target_mileage*100)}%"></div></div>`;

    const sorted=tm.map(m=>{
      const s=tr.filter(r=>r.member_id===m.id).reduce((a,b)=>a+Number(b.weighted_mileage),0);
      return {name:m.name,sum:s};
    }).sort((a,b)=>b.sum-a.sum);

    sorted.forEach((m,i)=>{
      const medal=i==0?"ğŸ¥‡":i==1?"ğŸ¥ˆ":i==2?"ğŸ¥‰":"";
      board.innerHTML+=`<div class="member">${m.name} ${m.sum.toFixed(3)}km ${medal}</div>`;
    });
  });
}

init();
load();
</script>
</body>
</html>
