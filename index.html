<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŠ ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;padding:12px;font-family:sans-serif;background:#f6f7f9}
section{background:#fff;border-radius:12px;padding:14px;margin-bottom:16px}
label{font-size:14px;margin-top:10px;display:block}
select,input,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
.checkbox-row{display:flex;align-items:center;gap:6px;font-size:14px;margin-top:6px}
button{background:#2563eb;color:#fff;border:none;margin-top:14px}
.team{margin-bottom:16px}
.team-title{font-weight:bold;margin-bottom:6px}
.progress{height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden;margin-bottom:8px}
.progress>div{height:100%;background:#22c55e}
.member{display:flex;justify-content:space-between;font-size:14px;padding:4px 0}
.proof{margin-left:6px}
</style>
</head>

<body>

<h2>ğŸŠ ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ ê¸°ë¡</h2>

<section>
<label>íŒ€</label>
<select id="teamSelect"></select>

<label>ë©¤ë²„</label>
<select id="memberSelect"></select>

<label>ê±°ë¦¬ (km)</label>
<input id="distance" type="number" step="0.001" placeholder="ì˜ˆ: 5.25">

<div class="checkbox-row">
<input type="checkbox" id="w3"> <label>3ì¸ ìˆ˜ì˜ x1.1</label>
</div>

<div class="checkbox-row">
<input type="checkbox" id="wSea"> <label>ë°”ë‹¤ ìˆ˜ì˜ x2</label>
</div>

<label>ì¦ë¹™ ì´ë¯¸ì§€</label>
<input type="file" id="proof" accept="image/*">

<button onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>
</section>

<section>
<h3>ğŸ“Š í˜„í™©</h3>
<div id="board"></div>
</section>

<script>
const SUPABASE_URL = "https://tsropshzbqrfladkgwsr.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const teamSel = document.getElementById("teamSelect");
const memberSel = document.getElementById("memberSelect");
const dist = document.getElementById("distance");
const w3 = document.getElementById("w3");
const wSea = document.getElementById("wSea");
const proofInput = document.getElementById("proof");
const board = document.getElementById("board");

let teams=[], members=[];

init();

async function init(){
  teams = (await sb.from("teams").select("*").order("id")).data || [];
  members = (await sb.from("members").select("*").order("id")).data || [];
  renderTeams();
  renderMembers();
  await loadBoard();
}

function renderTeams(){
  teamSel.innerHTML="";
  teams.forEach(t=>teamSel.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
}

function renderMembers(){
  memberSel.innerHTML="";
  members.filter(m=>m.team_id==teamSel.value)
    .forEach(m=>memberSel.innerHTML+=`<option value="${m.id}">${m.name}</option>`);
}
teamSel.onchange=renderMembers;

async function saveRecord(){
  const base=parseFloat(dist.value);
  if(!base) return alert("ê±°ë¦¬ ì…ë ¥");

  let weight=1;
  if(w3.checked) weight*=1.1;
  if(wSea.checked) weight*=2;
  const weighted=Math.floor(base*weight*10)/10;

  let proofUrl=null;
  if(proofInput.files[0]){
    const path=Date.now()+"_"+proofInput.files[0].name;
    await sb.storage.from("proofs").upload(path,proofInput.files[0]);
    proofUrl=sb.storage.from("proofs").getPublicUrl(path).data.publicUrl;
  }

  await sb.from("records").insert({
    member_id: memberSel.value,
    base_distance: base,
    weighted_mileage: weighted,
    weight_3person: w3.checked,
    weight_sea: wSea.checked,
    proof_url: proofUrl
  });

  dist.value=""; proofInput.value=""; w3.checked=false; wSea.checked=false;
  await loadBoard();
}

async function loadBoard(){
  board.innerHTML="";

  const { data } = await sb.from("records").select(`
    weighted_mileage,
    proof_url,
    members (
      name,
      team_id,
      teams (
        name,
        target_mileage
      )
    )
  `);

  const records = data || [];

  teams.forEach(team=>{
    const trs = records.filter(r=>r.members.team_id===team.id);
    const total = trs.reduce((s,r)=>s+r.weighted_mileage,0);

    const el=document.createElement("div");
    el.className="team";
    el.innerHTML=`
      <div class="team-title">${team.name} (${total.toFixed(1)} / ${team.target_mileage})</div>
      <div class="progress"><div style="width:${Math.min(100,total/team.target_mileage*100)}%"></div></div>
    `;

    trs.sort((a,b)=>b.weighted_mileage-a.weighted_mileage)
      .forEach((r,i)=>{
        const medal=i==0?"ğŸ¥‡":i==1?"ğŸ¥ˆ":i==2?"ğŸ¥‰":"";
        el.innerHTML+=`
          <div class="member">
            <span>${r.members.name} ${medal}</span>
            <span>${r.weighted_mileage.toFixed(1)}km
              ${r.proof_url?`<a class="proof" href="${r.proof_url}" target="_blank">ğŸ“</a>`:""}
            </span>
          </div>`;
      });

    board.appendChild(el);
  });
}
</script>
</body>
</html>
