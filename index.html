<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ í˜„í™©</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ===== ëª¨ë°”ì¼ ê°€ë¡œ ë„˜ì¹¨ ë°©ì§€ í•µì‹¬ ===== */
*, *::before, *::after {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f5f6f8;
}

/* ===== ë ˆì´ì•„ì›ƒ ===== */
h1 {
  text-align: center;
  padding: 16px 8px;
  margin: 0;
}

.container {
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  padding: 12px;
}

.card {
  width: 100%;
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}

/* ===== í¼ ===== */
select, input, button {
  width: 100%;
  max-width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}

button {
  background: #0066ff;
  color: #fff;
  font-weight: bold;
  border: none;
}

/* ì²´í¬ë°•ìŠ¤ */
.check {
  display: grid;
  grid-template-columns: 20px 1fr;
  gap: 8px;
  font-size: 14px;
  margin-top: 8px;
}

.check span {
  word-break: break-word;
  line-height: 1.4;
}

/* ë¯¸ë¦¬ë³´ê¸° */
.preview {
  background: #eef3ff;
  padding: 8px;
  border-radius: 6px;
  margin-top: 10px;
  font-size: 14px;
}

/* ===== í˜„í™© ===== */
.progress {
  width: 100%;
  height: 10px;
  background: #ddd;
  border-radius: 6px;
  overflow: hidden;
  margin: 6px 0 10px;
}

.progress div {
  height: 100%;
  background: #4caf50;
}

.team {
  margin-top: 14px;
  font-weight: bold;
}

.member, .rank {
  font-size: 14px;
  margin-left: 10px;
  word-break: break-word;
}
</style>
</head>

<body>

<h1>ğŸŠ ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ í˜„í™©</h1>

<div class="container">

  <!-- ê¸°ë¡ ì…ë ¥ -->
  <div class="card">
    <h2>ê¸°ë¡ ì¶”ê°€ / ìˆ˜ì •</h2>

    <select id="teamSelect"></select>
    <select id="memberSelect" disabled></select>

    <!-- ê±°ë¦¬ ì…ë ¥: ì†Œìˆ«ì  2ìë¦¬ -->
    <input type="number" id="distance" step="0.01" placeholder="ì˜ˆ: 3.25">

    <div class="check">
      <input type="checkbox" id="w3">
      <span>3ì¸ ìˆ˜ì˜ (x1.1)</span>
    </div>
    <div class="check">
      <input type="checkbox" id="wSea">
      <span>ë°”ë‹¤ ìˆ˜ì˜ (x2)</span>
    </div>

    <div class="preview">
      ê°€ì¤‘ì¹˜: <b id="wText">x1</b><br>
      ë°˜ì˜ ë§ˆì¼ë¦¬ì§€: <b id="mText">0.00</b>
    </div>

    <input type="file" id="proof">
    <button onclick="saveRecord()">ì €ì¥</button>
  </div>

  <!-- ë©¤ë²„ ë­í‚¹ -->
  <div class="card">
    <h2>ğŸ† ë©¤ë²„ ë­í‚¹</h2>
    <div id="ranking"></div>
  </div>

  <!-- íŒ€ í˜„í™© -->
  <div class="card">
    <h2>íŒ€ í˜„í™©</h2>
    <div id="board"></div>
  </div>

</div>

<script>
/* ===== Supabase ì„¤ì • ===== */
const SUPABASE_URL = "https://tsropshzbqrfladkgwsr.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DOM ===== */
const teamSel = document.getElementById("teamSelect");
const memberSel = document.getElementById("memberSelect");
const distInput = document.getElementById("distance");
const w3 = document.getElementById("w3");
const wSea = document.getElementById("wSea");

/* ===== ê°€ì¤‘ì¹˜ ê³„ì‚° ===== */
function calcWeight() {
  let w = 1;
  if (w3.checked) w *= 1.1;
  if (wSea.checked) w *= 2;

  document.getElementById("wText").innerText = "x" + w.toFixed(1);
  document.getElementById("mText").innerText =
    ((distInput.value || 0) * w).toFixed(2);
}

distInput.oninput = w3.onchange = wSea.onchange = calcWeight;

/* ===== ì´ˆê¸° ë¡œë”© ===== */
async function init() {
  const { data: teams } = await sb.from("teams").select("*").order("id");

  teamSel.innerHTML = `<option value="">íŒ€ ì„ íƒ</option>`;
  teams.forEach(t =>
    teamSel.innerHTML += `<option value="${t.id}">${t.name}</option>`
  );
}

teamSel.onchange = async () => {
  const { data: members } = await sb
    .from("members")
    .select("*")
    .eq("team_id", teamSel.value);

  memberSel.innerHTML = `<option value="">ë©¤ë²„ ì„ íƒ</option>`;
  members.forEach(m =>
    memberSel.innerHTML += `<option value="${m.id}">${m.name}</option>`
  );
  memberSel.disabled = false;
};

/* ===== ê¸°ë¡ ì €ì¥ ===== */
async function saveRecord() {
  let weight = 1;
  if (w3.checked) weight *= 1.1;
  if (wSea.checked) weight *= 2;

  let proofUrl = null;
  const file = document.getElementById("proof").files[0];
  if (file) {
    const path = `proofs/${Date.now()}_${file.name}`;
    await sb.storage.from("proofs").upload(path, file);
    proofUrl = sb.storage.from("proofs").getPublicUrl(path).data.publicUrl;
  }

  await sb.from("records").insert({
    member_id: memberSel.value,
    base_distance: Number(distInput.value).toFixed(3),
    weighted_mileage: (distInput.value * weight).toFixed(3),
    weight_3person: w3.checked,
    weight_sea: wSea.checked,
    proof_url: proofUrl
  });

  distInput.value = "";
  w3.checked = wSea.checked = false;
  calcWeight();
  loadBoard();
}

/* ===== í˜„í™© ë¡œë“œ ===== */
async function loadBoard() {
  const { data: teams } = await sb.from("teams").select("*");
  const { data: members } = await sb.from("members").select("*");
  const { data: records } = await sb.from("records").select("*");

  /* ë©¤ë²„ ë­í‚¹ */
  const sumByMember = {};
  records.forEach(r => {
    sumByMember[r.member_id] =
      (sumByMember[r.member_id] || 0) + Number(r.weighted_mileage);
  });

  const ranking = document.getElementById("ranking");
  ranking.innerHTML = "";
  Object.entries(sumByMember)
    .sort((a, b) => b[1] - a[1])
    .forEach(([id, sum], i) => {
      const name = members.find(m => m.id == id).name;
      ranking.innerHTML +=
        `<div class="rank">${i + 1}. ${name} ${sum.toFixed(1)}km</div>`;
    });

  /* íŒ€ í˜„í™© */
  const board = document.getElementById("board");
  board.innerHTML = "";

  teams.forEach(t => {
    const teamMembers = members.filter(m => m.team_id === t.id);
    const teamRecords = records.filter(r =>
      teamMembers.some(m => m.id === r.member_id)
    );

    const teamTotal = teamRecords.reduce(
      (s, r) => s + Number(r.weighted_mileage), 0
    );

    board.innerHTML += `
      <div class="team">â— ${t.name} (${teamTotal.toFixed(1)} / ${t.target_mileage})</div>
      <div class="progress">
        <div style="width:${Math.min(100, teamTotal / t.target_mileage * 100)}%"></div>
      </div>
    `;

    const sortedMembers = teamMembers.map(m => {
      const sum = teamRecords
        .filter(r => r.member_id === m.id)
        .reduce((a, b) => a + Number(b.weighted_mileage), 0);
      return { name: m.name, sum };
    }).sort((a, b) => b.sum - a.sum);

    sortedMembers.forEach((m, i) => {
      const medal = i === 0 ? "ğŸ¥‡" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : "";
      board.innerHTML +=
        `<div class="member">${m.name} ${m.sum.toFixed(1)}km ${medal}</div>`;
    });
  });
}

init();
loadBoard();
</script>

</body>
</html>
