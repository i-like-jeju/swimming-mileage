<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>ğŸŠâ€â™‚ï¸ ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ í˜„í™©</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f7f9;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    section {
      background: #fff;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
    }

    label {
      font-size: 14px;
      margin-top: 10px;
      display: block;
    }

    select, input[type="number"], input[type="file"], button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 14px;
      white-space: normal;
    }

    .checkbox-row input {
      flex-shrink: 0;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
      margin-top: 14px;
    }

    button:active {
      opacity: 0.8;
    }

    .team {
      margin-bottom: 16px;
    }

    .team-title {
      font-weight: bold;
      margin-bottom: 6px;
    }

    .progress {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress > div {
      height: 100%;
      background: #22c55e;
    }

    .member {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      padding: 4px 0;
      border-bottom: 1px dashed #eee;
    }

    .member:last-child {
      border-bottom: none;
    }

    .proof {
      margin-left: 6px;
      font-size: 13px;
    }
  </style>
</head>

<body>

<h1>ğŸŠâ€â™‚ï¸ ìˆ˜ì˜ ë§ˆì¼ë¦¬ì§€ ê¸°ë¡</h1>

<section>
  <label>íŒ€ ì„ íƒ</label>
  <select id="teamSelect"></select>

  <label>ë©¤ë²„ ì„ íƒ</label>
  <select id="memberSelect"></select>

  <label>ê±°ë¦¬ (km)</label>
  <input id="distance" type="number" step="0.001" placeholder="ì˜ˆ: 5.25" />

  <div class="checkbox-row">
    <input type="checkbox" id="w3" />
    <label for="w3">3ì¸ ìˆ˜ì˜ (x1.1)</label>
  </div>

  <div class="checkbox-row">
    <input type="checkbox" id="wSea" />
    <label for="wSea">ë°”ë‹¤ ìˆ˜ì˜ (x2)</label>
  </div>

  <label>ì¦ë¹™ ì´ë¯¸ì§€</label>
  <input type="file" id="proof" accept="image/*" />

  <button onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>
</section>

<section>
  <h2>ğŸ“Š íŒ€ / ë©¤ë²„ í˜„í™©</h2>
  <div id="board"></div>
</section>

<script>
  /* ===============================
     Supabase ì„¤ì •
     =============================== */
  const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  /* ===============================
     DOM ìš”ì†Œ
     =============================== */
  const teamSel = document.getElementById("teamSelect");
  const memberSel = document.getElementById("memberSelect");
  const dist = document.getElementById("distance");
  const w3 = document.getElementById("w3");
  const wSea = document.getElementById("wSea");
  const proofInput = document.getElementById("proof"); // âœ… ì—ëŸ¬ í•´ê²° í•µì‹¬
  const board = document.getElementById("board");

  let teams = [];
  let members = [];

  /* ===============================
     ì´ˆê¸° ë¡œë”©
     =============================== */
  loadInit();

  async function loadInit() {
    await loadTeams();
    await loadMembers();
    renderTeamSelect();
    renderMemberSelect();
    await loadBoard();
  }

  async function loadTeams() {
    const { data } = await supabase.from("teams").select("*").order("id");
    teams = data || [];
  }

  async function loadMembers() {
    const { data } = await supabase.from("members").select("*").order("id");
    members = data || [];
  }

  function renderTeamSelect() {
    teamSel.innerHTML = "";
    teams.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      teamSel.appendChild(opt);
    });
  }

  function renderMemberSelect() {
    memberSel.innerHTML = "";
    const teamId = teamSel.value;
    members.filter(m => m.team_id == teamId).forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      memberSel.appendChild(opt);
    });
  }

  teamSel.onchange = renderMemberSelect;

  /* ===============================
     ê¸°ë¡ ì €ì¥
     =============================== */
  async function saveRecord() {
    const base = parseFloat(dist.value);
    if (!base) return alert("ê±°ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

    let weight = 1;
    if (w3.checked) weight *= 1.1;
    if (wSea.checked) weight *= 2;

    const weighted = Math.floor(base * weight * 10) / 10;

    let proofUrl = null;
    const file = proofInput.files[0];

    if (file) {
      const path = `${Date.now()}_${file.name}`;
      const { error } = await supabase
        .storage
        .from("proofs")
        .upload(path, file);

      if (error) {
        alert("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
        return;
      }

      proofUrl = supabase
        .storage
        .from("proofs")
        .getPublicUrl(path).data.publicUrl;
    }

    await supabase.from("records").insert({
      member_id: memberSel.value,
      base_distance: base,
      weighted_mileage: weighted,
      weight_3person: w3.checked,
      weight_sea: wSea.checked,
      proof_url: proofUrl
    });

    dist.value = "";
    proofInput.value = "";
    w3.checked = false;
    wSea.checked = false;

    await loadBoard();
  }

  /* ===============================
     í˜„í™© ë¡œë“œ
     =============================== */
  async function loadBoard() {
    board.innerHTML = "";

    const { data: records } = await supabase
      .from("records")
      .select("*, members(name, team_id), teams(name, target_mileage)")
      .order("id");

    teams.forEach(team => {
      const teamRecords = records.filter(
        r => r.members.team_id === team.id
      );

      const total = teamRecords.reduce(
        (s, r) => s + r.weighted_mileage, 0
      );

      const wrap = document.createElement("div");
      wrap.className = "team";

      wrap.innerHTML = `
        <div class="team-title">${team.name} (${total.toFixed(1)} / ${team.target_mileage})</div>
        <div class="progress">
          <div style="width:${Math.min(100, total / team.target_mileage * 100)}%"></div>
        </div>
      `;

      teamRecords
        .sort((a, b) => b.weighted_mileage - a.weighted_mileage)
        .forEach((r, idx) => {
          const medal = idx === 0 ? "ğŸ¥‡" : idx === 1 ? "ğŸ¥ˆ" : idx === 2 ? "ğŸ¥‰" : "";
          const row = document.createElement("div");
          row.className = "member";
          row.innerHTML = `
            <span>${r.members.name} ${medal}</span>
            <span>${r.weighted_mileage.toFixed(1)}km
              ${r.proof_url ? `<a class="proof" href="${r.proof_url}" target="_blank">ğŸ“</a>` : ""}
            </span>
          `;
          wrap.appendChild(row);
        });

      board.appendChild(wrap);
    });
  }
</script>

</body>
</html>
