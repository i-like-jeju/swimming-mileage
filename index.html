<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§ˆì¼ë¦¬ì§€ í˜„í™©</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      margin: 0;
      background: #f5f6f8;
    }
    h1 {
      text-align: center;
      padding: 16px;
    }
    .container {
      padding: 12px;
      max-width: 480px;
      margin: auto;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 10px;
      font-size: 14px;
    }
    select, input, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #0066ff;
      color: #fff;
      border: none;
      margin-top: 14px;
      font-weight: bold;
    }
    button:active {
      opacity: .8;
    }
    .weights label {
      font-weight: normal;
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 6px;
    }
    .preview {
      margin-top: 10px;
      font-size: 14px;
      background: #f0f3ff;
      padding: 8px;
      border-radius: 6px;
    }
    .team {
      margin-bottom: 20px;
    }
    .progress {
      height: 10px;
      background: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress div {
      height: 100%;
      background: #4caf50;
    }
    ul {
      padding-left: 16px;
    }
    li {
      font-size: 14px;
      margin-bottom: 4px;
    }
    a {
      font-size: 12px;
    }
  </style>
</head>

<body>
<h1>ğŸŠ ë§ˆì¼ë¦¬ì§€ í˜„í™©</h1>

<div class="container">

  <!-- ì…ë ¥ í¼ -->
  <div class="card">
    <h2>ê¸°ë¡ ì¶”ê°€</h2>

    <label>íŒ€</label>
    <select id="teamSelect"></select>

    <label>ë©¤ë²„</label>
    <select id="memberSelect" disabled></select>

    <label>ìˆ˜ì˜ ê±°ë¦¬ (km)</label>
    <input type="number" id="distance" step="0.1">

    <div class="weights">
      <label><input type="checkbox" id="w3"> 3ì¸ ìˆ˜ì˜ (x1.1)</label>
      <label><input type="checkbox" id="wSea"> ë°”ë‹¤ ìˆ˜ì˜ (x2)</label>
    </div>

    <div class="preview">
      ì ìš© ê°€ì¤‘ì¹˜: <b id="weightText">x1</b><br/>
      ë°˜ì˜ ë§ˆì¼ë¦¬ì§€: <b id="resultText">0</b> km
    </div>

    <label>ì¦ë¹™ íŒŒì¼</label>
    <input type="file" id="proof">

    <button onclick="saveRecord()">ì €ì¥</button>
  </div>

  <!-- íŒ€ í˜„í™© -->
  <div id="teams"></div>

</div>

<script>
  /* ğŸ”§ Supabase ì„¤ì • */
  const supabase = supabaseJs.createClient(
    "https://tsropshzbqrfladkgwsr.supabase.co",
    "sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm"
  );

  const teamSelect = document.getElementById("teamSelect");
  const memberSelect = document.getElementById("memberSelect");
  const distanceInput = document.getElementById("distance");
  const w3 = document.getElementById("w3");
  const wSea = document.getElementById("wSea");

  function calcWeight() {
    let w = 1;
    if (w3.checked) w *= 1.1;
    if (wSea.checked) w *= 2;
    const d = parseFloat(distanceInput.value) || 0;
    document.getElementById("weightText").innerText = "x" + w.toFixed(1);
    document.getElementById("resultText").innerText = (d * w).toFixed(1);
  }

  distanceInput.oninput = w3.onchange = wSea.onchange = calcWeight;

  async function loadTeams() {
    const { data } = await supabase.from("teams").select("*").order("id");
    teamSelect.innerHTML = `<option value="">íŒ€ ì„ íƒ</option>`;
    data.forEach(t => {
      teamSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
    });
  }

  teamSelect.onchange = async () => {
    memberSelect.disabled = true;
    memberSelect.innerHTML = "";
    const teamId = teamSelect.value;
    if (!teamId) return;

    const { data } = await supabase
      .from("members")
      .select("*")
      .eq("team_id", teamId);

    memberSelect.innerHTML = `<option value="">ë©¤ë²„ ì„ íƒ</option>`;
    data.forEach(m => {
      memberSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
    });
    memberSelect.disabled = false;
  };

  async function saveRecord() {
    if (!memberSelect.value || !distanceInput.value) {
      alert("í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }

    let weight = 1;
    if (w3.checked) weight *= 1.1;
    if (wSea.checked) weight *= 2;

    let proofUrl = null;
    const file = document.getElementById("proof").files[0];
    if (file) {
      const path = `proofs/${Date.now()}_${file.name}`;
      await supabase.storage.from("proofs").upload(path, file);
      const { data } = supabase.storage.from("proofs").getPublicUrl(path);
      proofUrl = data.publicUrl;
    }

    await supabase.from("records").insert({
      member_id: memberSelect.value,
      base_distance: distanceInput.value,
      weight_3person: w3.checked,
      weight_sea: wSea.checked,
      weighted_mileage: (distanceInput.value * weight).toFixed(1),
      proof_url: proofUrl
    });

    alert("ì €ì¥ ì™„ë£Œ");
    location.reload();
  }

  async function loadBoard() {
    const { data: teams } = await supabase.from("teams").select("*").order("id");

    const container = document.getElementById("teams");
    container.innerHTML = "";

    for (const t of teams) {
      const { data: rows } = await supabase
        .from("records")
        .select("weighted_mileage, proof_url, members(name)")
        .eq("members.team_id", t.id);

      const total = rows.reduce((a,b)=>a+Number(b.weighted_mileage),0);
      const percent = Math.min(100, total / t.target_mileage * 100);

      let html = `
        <div class="card team">
          <h3>${t.name} (${total.toFixed(1)} / ${t.target_mileage})</h3>
          <div class="progress"><div style="width:${percent}%"></div></div>
          <ul>
      `;

      rows.forEach(r=>{
        html += `<li>${r.members.name} : ${r.weighted_mileage}km
          ${r.proof_url ? `<a href="${r.proof_url}" target="_blank">[ì¦ë¹™]</a>` : ``}
        </li>`;
      });

      html += "</ul></div>";
      container.innerHTML += html;
    }
  }

  loadTeams();
  loadBoard();
</script>
</body>
</html>
